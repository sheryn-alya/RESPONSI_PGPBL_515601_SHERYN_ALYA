<!DOCTYPE html>
<html>

<head>
    <title>Firebase a Leaflet Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>


<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>


    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>


    <!-- Add the Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>

        // Firebase configuration SHERYN
        const firebaseConfig = {
            apiKey: "AIzaSyDh4QSB5jq_hMuqlivhfyrUsj4cHOYmIbE",
            authDomain: "pgpbl2025-20755.firebaseapp.com",
            databaseURL: "https://pgpbl2025-20755-default-rtdb.firebaseio.com",
            projectId: "pgpbl2025-20755",
            storageBucket: "pgpbl2025-20755.firebasestorage.app",
            messagingSenderId: "618473656220",
            appId: "1:618473656220:web:fbe07106354736bdc0c259"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Initialize the map
        const map = L.map('map').setView([-7.7956, 110.3695], 13);

        // Add a tile layer (the map background)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Get a reference to the database service
        const pointsRef = database.ref("/points");

        // Attach an asynchronous callback to read the data at our posts reference
        pointsRef.on('value', (e) => {
            const data = e.val();
            console.log(data);
            if (data) {
                Object.keys(data).forEach((key) => {
                    const point = data[key];
                    if (point.coordinates) {
                        // change coordinates to float and trim spaces
                        const coords = point.coordinates.split(",").map(s => parseFloat(s.trim()));
                        console.log(coords);
                        const marker = L.marker(coords).addTo(map);
                        const name = point.name ? point.name : 'No name';
                        // popup includes a delete button which calls deletePoint with the record key
                        const popup = `${name}<br>${coords.join(', ')}<br><button onclick="deletePoint('${key}')"><i class="fa-solid fa-trash"></i> Hapus</button>`;

                        marker.bindPopup(popup);
                    }
                });
            }
        }, (errorObject) => {
            console.log("The read failed: " + errorObject.name);
        });

        // Delete point
        function deletePoint(key) {
            // confirm
            if (confirm("Yakin akan menghapus point ini?")) {
                pointsRef.child(key).remove();
                // reload page to refresh markers (alternatively re-draw markers programmatically)
                window.location.reload();
            }
        }


    </script>
</body>

</html>